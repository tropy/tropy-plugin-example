# The Tropy Plugin System

Tropy plugins, which are essentially JavaScript packages that follow a specified convention. They can extend the `import` and/or `export` functions of Tropy via [hooks](#hooks).

For a detailed guide on writing a sample plugin, please follow the [Plugin Tutorial](./tutorial.md).

- [The Tropy Plugin System](#the-tropy-plugin-system)
  - [API](#api)
  - [Configuration](#configuration)
  - [Context](#context)
  - [Runtime](#runtime)
    - [Dependencies](#dependencies)
  - [Hooks](#hooks)
    - [Export](#export)
    - [Import](#import)
  - [Developing and debugging](#developing-and-debugging)
  - [Releasing and Distributing](#releasing-and-distributing)
    - [Installing the released plugin](#installing-the-released-plugin)
  
## API

Each plugin contains a `package.json` file, which defines a `hooks` property, that specifies
which Tropy functionality the plugin wants to extend.

```js
{
  "name": "my-plugin",
  "hooks": {
    "export": false,
    "import": true
  }
}
```

The package's main file, `src/plugin.js` should export a class with the following constructor

```js
class Plugin {
  constructor(options, context) {
  }
  async export(data) {
  }
  async import(payload) {
  }
}

module.exports = Plugin
```

The `options` parameter receives the plugin's configuration object (see [configuration](./configuration.md)),
the `context` object various APIs provided by Tropy, notably the logger.

The `Plugin` class must define an instance method for each of the hooks it registers in its `package.json`.

## Configuration

The user configures the plugins via the *Preferences > Plugins* GUI in Tropy, or the by editing a `config.json` in the `<appData>/plugins` folder. For more details about creating the configuration GUI, see [the configuration reference](./configuration.md).

The `config.json` file contains an array of *plugin instances*.
Plugin instances are distinguished from plugins, because a single plugin could have multiple instances (e.g. the omeka-export plugin could export to a staging and a production instance).

Each instance is defined by an object that looks like this:

```json
{
  "plugin": "plugin-name",
  "name": "My Plugin",
  "options": {
    "some": "option"
  }
}
```

`plugin` should match the installed package name, `name` is a label the user will see where
appropriate, `options` is an object that will be passed to the plugin's constructor. The values available in `options` are those defined by your plugin in the `options` array in `package.json`.

## Context

```js
{
  logger: // Write to Tropy's logger: src/common/log.js
  dialog: // Open a GUI dialog: src/dialog.js
  json: // Utilities for working with JSON-LD: src/common/json.js
  window: // Window object, including access to the global store
  require: // Access Tropy's dependencies: (packageName) => {}
}
```

The [logger](https://github.com/tropy/tropy/blob/master/src/common/log.js#L26)
object contains methods like `verbose` or `info`, useful for debugging and writing to Tropy's
log files.

`require` is used like the built-in `require`, it is needed to require packages that Tropy uses
(see [package.json](https://github.com/tropy/tropy/blob/master/package.json#L106)),
e.g. `bluebird` or `jsonld` - so your package does not need to bundle those dependencies.

## Runtime

If the configuration in `<appData>/plugins/config.json` defines a plugin `my-plugin`, Tropy will look for a folder `my-plugin` in its `<userData>/plugins` directory.
If none is found, it will look in `<userData>/plugins/node_modules`, for plugins installed via npm.

Tropy will try to reload the plugin source each time the configuration file is modified, without the
need to restart. When you make changes to the plugin source, you will need to reload Tropy (Ctrl-R or Cmd-R)

### Dependencies

Plugins can come with their own dependencies, defined in `package.json`.
Dependencies that are not shipped with Tropy, need to be bundled with your plugin using a module bundler, e.g. *rollup.js*.
This plugin boilerplate comes with Rollup already configured.

## Hooks

Your plugin specifies which hooks it responds to in its `package.json` under the `hooks` key, and must include an async method on the `Plugin` class with the same name as the hook.

### Export

`Plugin.export` instance method will be called with the jsonld-compressed results of the export, as generated by the `Export` class in [`tropy/src/commands/item/import.js`](https://github.com/tropy/tropy/blob/master/src/commands/item/export.js#L30).

### Import

`Plugin.import` instance method will be called with a `payload` object including some state information.
The data to be imported needs to be added to an array in `payload.data` by the `import` method, which is then processed by the  `Import` class in [`tropy/src/commands/item/import.js`](https://github.com/tropy/tropy/blob/master/src/commands/item/import.js#L48).

## Developing and debugging

For development, you can symlink your project to the `<userData>/plugins/my-plugin` directory, specifically the `index.js` and `package.json` files from the root of your plugin repository.
Generate `index.js` using Rollup with the command `npm run watch` for live updates to the file while you are developing.

When you are developing, tick the *Tropy > Preferences > Global > Enable Developer Mode* checkbox to enable the *Developer* menu.
A new menu entry *Developer > Toggle Developer Tools* will show the Chrome DevTools.

You will be able to see the output of `console.log()` statements in DevTools, as well as access information from Tropy's state by typing `tropy.state()` at the console.

You can also include `debugger` somewhere in your code, and execution will pause, allowing you to inspect the scope.

Alternatively, you can use Tropy's logger, which is passed into your plugin via the `context` parameter.
Use `this.context.logger('message')` to write to the *project.log* file in the Tropy logs folder.

## Releasing and Distributing

When you are ready to share the plugin with other users, create a tag in your git repository and push it to GitHub, for example

```sh
git tag v1.0.0
git push origin v1.0.0
```

The `release.yml` workflow provided with this template will create a release in GitHub, consisting of a zip file with your plugin's name and version number, and source code archives. Users should download the named zip file, not the source code archives - these are added to a release automatically for debugging purposes.

When you have a release ready to distribute, you can edit the release in GitHub to write some release notes and remove the `pre-release` flag. The release will then be shown to users as the "latest" release on the repository's homepage.

### Installing the released plugin

Open the Preferences window and navigate to the *Plugins* pane.
Click the *Install Plugin* button in the footer and navigate to the archive file of the plugin.
Tropy will extract the archive into the `<plugin-name>` directory and a new entry in the list of plugins will appear.
Click the *enable* button and fill in the configuration options.

After closing the preferences dialog, the plugin functionality will be activated.
If it is an export plugin for example, an entry will appear in the export context menu for selected items.
